---
- name: æ£€æŸ¥æ˜¯å¦å¯ç”¨å¼€å‘å·¥å…·å®‰è£…
  ansible.builtin.debug:
    msg: "å¼€å‘å·¥å…·å®‰è£…å·²å¯ç”¨ï¼Œç›®æ ‡ä¸»æœº: {{ dev_target_hosts }}"
  when: dev_tools_enabled

- name: æ£€æŸ¥å½“å‰ä¸»æœºæ˜¯å¦åœ¨ç›®æ ‡ä¸»æœºåˆ—è¡¨ä¸­
  ansible.builtin.set_fact:
    dev_install_on_this_host: "{{ inventory_hostname in dev_target_hosts }}"

- name: æ˜¾ç¤ºä¸»æœºå®‰è£…çŠ¶æ€
  ansible.builtin.debug:
    msg: "{{ inventory_hostname }}: {{ 'å°†å®‰è£…å¼€å‘å·¥å…·' if dev_install_on_this_host else 'è·³è¿‡å®‰è£…' }}"

# Charm ä»“åº“é…ç½®ä»»åŠ¡ç»„
- name: åˆ›å»º APT keyring ç›®å½•
  ansible.builtin.file:
    path: "/etc/apt/keyrings"
    state: directory
    mode: '0755'
    owner: root
    group: root
  become: true
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled

- name: ä¸‹è½½ Charm GPG å¯†é’¥
  ansible.builtin.get_url:
    url: "{{ dev_charm_gpg_key_url }}"
    dest: "/tmp/charm.gpg.key"
    mode: '0644'
    timeout: 30
  become: true
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled
  register: dev_charm_key_download

- name: å®‰è£… Charm GPG å¯†é’¥
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      gpg --dearmor < /tmp/charm.gpg.key > {{ dev_charm_keyring_path }}
    executable: /bin/bash
    creates: "{{ dev_charm_keyring_path }}"
  become: true
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled
    - dev_charm_key_download is succeeded

- name: è®¾ç½® GPG å¯†é’¥æ–‡ä»¶æƒé™
  ansible.builtin.file:
    path: "{{ dev_charm_keyring_path }}"
    owner: "{{ dev_keyring_owner }}"
    group: "{{ dev_keyring_group }}"
    mode: "{{ dev_keyring_mode }}"
  become: true
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled

- name: æ·»åŠ  Charm è½¯ä»¶æº
  ansible.builtin.copy:
    content: "{{ dev_charm_repository }}\n"
    dest: "{{ dev_charm_sources_list }}"
    owner: root
    group: root
    mode: "{{ dev_sources_mode }}"
    backup: true
  become: true
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled
  notify: æ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜

- name: æ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled

# Crush å®‰è£…ä»»åŠ¡
- name: å®‰è£… Crush AI ç¼–ç åŠ©æ‰‹
  ansible.builtin.package:
    name: "{{ dev_crush_package }}"
    state: present
  become: true
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled
    - dev_crush_enabled
  register: dev_crush_install_result

- name: å®‰è£…é¢å¤–çš„å¼€å‘å·¥å…·åŒ…
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop: "{{ dev_additional_packages }}"
  become: true
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_additional_packages | length > 0

# éªŒè¯å®‰è£…ç»“æœ
- name: éªŒè¯ Crush å®‰è£…çŠ¶æ€
  ansible.builtin.command:
    cmd: crush --version
  register: dev_crush_version_check
  changed_when: false
  failed_when: false
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled
    - dev_crush_enabled
    - dev_verify_installation

- name: æ˜¾ç¤º Crush ç‰ˆæœ¬ä¿¡æ¯
  ansible.builtin.debug:
    msg: |
      ğŸ‰ Crush AI ç¼–ç åŠ©æ‰‹å®‰è£…éªŒè¯ç»“æœ:
      - å®‰è£…çŠ¶æ€: {{ 'SUCCESS' if dev_crush_version_check.rc == 0 else 'FAILED' }}
      - ç‰ˆæœ¬ä¿¡æ¯: {{ dev_crush_version_check.stdout if dev_crush_version_check.rc == 0 else 'æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯' }}
      - å‘½ä»¤ä½ç½®: /usr/bin/crush
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled
    - dev_crush_enabled
    - dev_verify_installation

- name: éªŒè¯ GPG å¯†é’¥æ–‡ä»¶å®Œæ•´æ€§
  ansible.builtin.stat:
    path: "{{ dev_charm_keyring_path }}"
  register: dev_gpg_key_stat
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled
    - dev_verify_installation

- name: æ˜¾ç¤º GPG å¯†é’¥éªŒè¯ç»“æœ
  ansible.builtin.debug:
    msg: |
      ğŸ” GPG å¯†é’¥éªŒè¯ç»“æœ:
      - æ–‡ä»¶å­˜åœ¨: {{ dev_gpg_key_stat.stat.exists }}
      - æ–‡ä»¶å¤§å°: {{ dev_gpg_key_stat.stat.size }} bytes
      - æƒé™è®¾ç½®: {{ dev_gpg_key_stat.stat.mode }}
      - æ‰€æœ‰è€…: {{ dev_gpg_key_stat.stat.pw_name }}:{{ dev_gpg_key_stat.stat.gr_name }}
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_charm_enabled
    - dev_verify_installation

# å®‰è£…å®Œæˆæ‘˜è¦
- name: æ˜¾ç¤ºå¼€å‘å·¥å…·å®‰è£…æ‘˜è¦
  ansible.builtin.debug:
    msg: |
      ğŸ“¦ å¼€å‘å·¥å…·å®‰è£…å®Œæˆæ‘˜è¦ ({{ inventory_hostname }}):

      âœ… å·²å®‰è£…çš„å·¥å…·:
      {% if dev_crush_enabled and dev_install_on_this_host %}
      - Crush AI ç¼–ç åŠ©æ‰‹: {{ 'SUCCESS' if dev_crush_install_result is succeeded else 'FAILED' }}
      {% endif %}
      {% if dev_additional_packages | length > 0 and dev_install_on_this_host %}
      - é™„åŠ è½¯ä»¶åŒ…: {{ dev_additional_packages | join(', ') }}
      {% endif %}

      ğŸ“‚ é…ç½®æ–‡ä»¶ä½ç½®:
      - GPG å¯†é’¥: {{ dev_charm_keyring_path }}
      - è½¯ä»¶æº: {{ dev_charm_sources_list }}

      ğŸ¯ ä½¿ç”¨è¯´æ˜:
      - è¿è¡Œ crush --help æŸ¥çœ‹ä½¿ç”¨å¸®åŠ©
      - å¯åŠ¨ AI ç¼–ç åŠ©æ‰‹: crush
      - åœ¨é¡¹ç›®ç›®å½•ä¸­ä½¿ç”¨: cd your-project && crush

      ğŸ’¡ ç®¡ç†å‘½ä»¤:
      - æŸ¥çœ‹å·²å®‰è£…ç‰ˆæœ¬: crush --version
      - æ›´æ–°è½¯ä»¶åŒ…: sudo apt update && sudo apt upgrade crush
      - å¸è½½è½¯ä»¶: sudo apt remove crush
  when:
    - dev_tools_enabled
    - dev_install_on_this_host

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- name: æ¸…ç†ä¸´æ—¶ä¸‹è½½æ–‡ä»¶
  ansible.builtin.file:
    path: "/tmp/charm.gpg.key"
    state: absent
  become: true
  when:
    - dev_tools_enabled
    - dev_install_on_this_host
    - dev_cleanup_temp_files
