# Dify Environment Configuration
# Generated by Ansible for {{ ansible_hostname }}
# Generated at: {{ ansible_date_time.iso8601 }}

# ------------------------------
# Common Variables
# ------------------------------
{% for key, value in dify_env.items() %}
{{ key }}={{ value }}
{% endfor %}

# ------------------------------
# Nginx Configuration
# ------------------------------
NGINX_SERVER_NAME=_
NGINX_HTTPS_ENABLED={{ dify_enable_ssl | string | lower }}
NGINX_PORT=80
NGINX_SSL_PORT=443
NGINX_WORKER_PROCESSES=auto
NGINX_CLIENT_MAX_BODY_SIZE=100M
NGINX_KEEPALIVE_TIMEOUT=65
NGINX_PROXY_READ_TIMEOUT=3600s
NGINX_PROXY_SEND_TIMEOUT=3600s

# ------------------------------
# Sandbox Configuration
# ------------------------------
SANDBOX_GIN_MODE=release
SANDBOX_WORKER_TIMEOUT=15
SANDBOX_ENABLE_NETWORK=true
SANDBOX_HTTP_PROXY=http://ssrf_proxy:3128
SANDBOX_HTTPS_PROXY=http://ssrf_proxy:3128
SANDBOX_PORT=8194

# ------------------------------
# SSRF Proxy Configuration
# ------------------------------
SSRF_HTTP_PORT=3128
SSRF_COREDUMP_DIR=/var/spool/squid
SSRF_REVERSE_PROXY_PORT=8194
SSRF_SANDBOX_HOST=sandbox

# ------------------------------
# Performance Configuration
# ------------------------------
SERVER_WORKER_AMOUNT={{ dify_api_workers }}
PM2_INSTANCES={{ dify_web_instances }}
GUNICORN_TIMEOUT=360
CELERY_WORKER_AMOUNT=1

# ------------------------------
# Additional Plugin Configuration
# ------------------------------
PLUGIN_REMOTE_INSTALL_HOST=0.0.0.0
PLUGIN_REMOTE_INSTALL_PORT=5003
PLUGIN_DEBUGGING_HOST=0.0.0.0
PLUGIN_DEBUGGING_PORT=5003
EXPOSE_PLUGIN_DEBUGGING_HOST=localhost
EXPOSE_PLUGIN_DEBUGGING_PORT=5003
MARKETPLACE_ENABLED=true
MARKETPLACE_API_URL=https://marketplace.dify.ai

# ------------------------------
# Security Configuration
# ------------------------------
{% if dify_enable_ssl %}
# SSL Configuration
NGINX_SSL_CERT_FILENAME=dify.crt
NGINX_SSL_CERT_KEY_FILENAME=dify.key
NGINX_SSL_PROTOCOLS=TLSv1.2 TLSv1.3

# Certbot Configuration
CERTBOT_EMAIL={{ dify_ssl_email | default('admin@localhost') }}
CERTBOT_DOMAIN={{ dify_ssl_domain | default('localhost') }}
{% else %}
# Certbot Configuration (disabled)
CERTBOT_EMAIL=
CERTBOT_DOMAIN=
{% endif %}

# ------------------------------
# Docker Compose Profiles
# ------------------------------
COMPOSE_PROFILES={{ dify_compose_profiles | join(',') }}

# ------------------------------
# Additional Environment Variables
# ------------------------------
# Ensure UTF-8 encoding
PYTHONIOENCODING=utf-8

# Log configuration
LOG_LEVEL=INFO
LOG_FILE=/app/logs/server.log
LOG_FILE_MAX_SIZE=20
LOG_FILE_BACKUP_COUNT=5
LOG_DATEFORMAT=%Y-%m-%d %H:%M:%S
LOG_TZ={{ dify_env.TZ }}

# Migration settings
MIGRATION_ENABLED=true

# Files configuration
FILES_ACCESS_TIMEOUT=300
UPLOAD_FILE_SIZE_LIMIT=15
UPLOAD_FILE_BATCH_LIMIT=5
UPLOAD_IMAGE_FILE_SIZE_LIMIT=10
UPLOAD_VIDEO_FILE_SIZE_LIMIT=100
UPLOAD_AUDIO_FILE_SIZE_LIMIT=50

# Workflow configuration
WORKFLOW_MAX_EXECUTION_STEPS=500
WORKFLOW_MAX_EXECUTION_TIME=1200
WORKFLOW_CALL_MAX_DEPTH=5
MAX_VARIABLE_SIZE=204800

# Token limits
ACCESS_TOKEN_EXPIRE_MINUTES=60
REFRESH_TOKEN_EXPIRE_DAYS=30

# Rate limiting
APP_MAX_ACTIVE_REQUESTS=0
APP_MAX_EXECUTION_TIME=1200

# Indexing configuration
INDEXING_MAX_SEGMENTATION_TOKENS_LENGTH=4000

# API Tool configuration
API_TOOL_DEFAULT_CONNECT_TIMEOUT=10
API_TOOL_DEFAULT_READ_TIMEOUT=60

# CORS configuration
WEB_API_CORS_ALLOW_ORIGINS=*
CONSOLE_CORS_ALLOW_ORIGINS=*

# Feature flags
ENABLE_REQUEST_LOGGING=False
CHECK_UPDATE_URL=https://updates.dify.ai
SCARF_NO_ANALYTICS=true

# Database optimization
SQLALCHEMY_POOL_SIZE=30
SQLALCHEMY_POOL_RECYCLE=3600
SQLALCHEMY_ECHO=false
SQLALCHEMY_POOL_PRE_PING=false
SQLALCHEMY_POOL_USE_LIFO=false

# PostgreSQL performance
POSTGRES_MAX_CONNECTIONS=100
POSTGRES_SHARED_BUFFERS=128MB
POSTGRES_WORK_MEM=4MB
POSTGRES_MAINTENANCE_WORK_MEM=64MB
POSTGRES_EFFECTIVE_CACHE_SIZE=1024MB

# Redis configuration
REDIS_USE_SSL=false
REDIS_USE_SENTINEL=false
REDIS_USE_CLUSTERS=false
BROKER_USE_SSL=false

# Weaviate configuration (if used)
{% if dify_vector_store == 'weaviate' %}
WEAVIATE_PERSISTENCE_DATA_PATH=/var/lib/weaviate
WEAVIATE_QUERY_DEFAULTS_LIMIT=25
WEAVIATE_AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=false
WEAVIATE_DEFAULT_VECTORIZER_MODULE=none
WEAVIATE_CLUSTER_HOSTNAME=node1
WEAVIATE_AUTHENTICATION_APIKEY_ENABLED=true
WEAVIATE_AUTHENTICATION_APIKEY_ALLOWED_KEYS={{ dify_env.WEAVIATE_API_KEY }}
WEAVIATE_AUTHENTICATION_APIKEY_USERS=hello@dify.ai
WEAVIATE_AUTHORIZATION_ADMINLIST_ENABLED=true
WEAVIATE_AUTHORIZATION_ADMINLIST_USERS=hello@dify.ai
{% endif %}

# Monitoring configuration
{% if dify_monitoring_enabled %}
ENABLE_OTEL=true
OTLP_BASE_ENDPOINT={{ dify_monitoring_endpoint }}
OTEL_SAMPLING_RATE=0.1
{% else %}
ENABLE_OTEL=false
{% endif %}

# Development configuration
{% if dify_enable_debug %}
FLASK_DEBUG=true
{% endif %}

# Custom configuration from inventory
{% if dify_custom_env is defined %}
# Custom environment variables
{% for key, value in dify_custom_env.items() %}
{{ key }}={{ value }}
{% endfor %}
{% endif %}