---
- name: åˆ›å»º Dify ç›®å½•ç»“æž„
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop:
    - "{{ dify_base_path }}"
    - "{{ dify_compose_path }}"
    - "{{ dify_compose_path }}/volumes"
  become: true

- name: ç”Ÿæˆ Docker Compose é…ç½®æ–‡ä»¶
  ansible.builtin.template:
    src: docker-compose.yaml.j2
    dest: "{{ dify_compose_path }}/docker-compose.yaml"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    backup: true

- name: åˆ›å»º Nginx é…ç½®æ–‡ä»¶
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ dify_compose_path }}/nginx.conf"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: åˆ›å»º Sandbox é…ç½®æ–‡ä»¶
  ansible.builtin.template:
    src: sandbox-config.yaml.j2
    dest: "{{ dify_compose_path }}/sandbox-config.yaml"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: åˆ›å»º SSRF ä»£ç†é…ç½®æ–‡ä»¶
  ansible.builtin.template:
    src: ssrf_proxy.conf.j2
    dest: "{{ dify_compose_path }}/ssrf_proxy.conf"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: ç”Ÿæˆ .env çŽ¯å¢ƒé…ç½®æ–‡ä»¶
  ansible.builtin.template:
    src: env.j2
    dest: "{{ dify_compose_path }}/.env"
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    backup: true
  notify: é‡å¯ Dify æœåŠ¡

- name: åˆ›å»ºå¤–éƒ¨ç½‘ç»œï¼ˆå¦‚æžœéœ€è¦ï¼‰
  community.docker.docker_network:
    name: "{{ item.name }}"
    state: present
  loop: "{{ dify_networks }}"
  when: item.external is defined and item.external

- name: éƒ¨ç½² Dify Docker Compose æ ˆ
  community.docker.docker_compose_v2:
    project_src: "{{ dify_compose_path }}"
    project_name: "{{ dify_project_name }}"
    env_files:
      - "{{ dify_compose_path }}/.env"
    profiles: "{{ dify_compose_profiles }}"
    services: "{{ dify_compose_services if dify_compose_services else omit }}"
    state: "{{ dify_compose_state }}"
    build: "{{ dify_compose_build }}"
    pull: "{{ dify_compose_pull }}"
    remove_orphans: "{{ dify_compose_remove_orphans }}"
    recreate: "{{ dify_compose_recreate }}"
    wait: true
    wait_timeout: 300
  register: dify_compose_result

- name: æ˜¾ç¤ºéƒ¨ç½²ç»“æžœ
  ansible.builtin.debug:
    var: dify_compose_result
    verbosity: 1

- name: ç­‰å¾…æœåŠ¡å°±ç»ª
  ansible.builtin.uri:
    url: "http://localhost:{{ dify_nginx_port }}/health"
    method: GET
    status_code: [200, 404]  # 404 ä¹Ÿè¡¨ç¤º Nginx æ­£å¸¸è¿è¡Œ
  register: dify_health_check
  retries: 12
  delay: 10
  until: dify_health_check is not failed
  ignore_errors: true

- name: æ˜¾ç¤º Dify éƒ¨ç½²çŠ¶æ€
  ansible.builtin.debug:
    msg: |
      ðŸŽ‰ Dify éƒ¨ç½²å®Œæˆï¼

      ðŸ“ è®¿é—®ä¿¡æ¯ï¼š
      - Web ç•Œé¢: http://{{ ansible_default_ipv4.address }}:{{ dify_nginx_port }}
      - çŠ¶æ€æ£€æŸ¥: {{ 'SUCCESS' if dify_health_check is not failed else 'PENDING' }}

      âš™ï¸ éƒ¨ç½²é…ç½®ï¼š
      - é¡¹ç›®åç§°: {{ dify_project_name }}
      - å‘é‡æ•°æ®åº“: {{ dify_vector_store | default('weaviate') }}
      - å­˜å‚¨ç±»åž‹: {{ dify_storage_type | default('opendal') }}
      - è°ƒè¯•æ¨¡å¼: {{ dify_enable_debug | default(false) }}

      ðŸ“ åˆå§‹åŒ–è¯´æ˜Žï¼š
      {% if vault_dify_init_password is defined and vault_dify_init_password %}
      - ç®¡ç†å‘˜å¯†ç å·²é¢„è®¾ï¼Œå¯ç›´æŽ¥ç™»å½•
      {% else %}
      - âš ï¸  é¦–æ¬¡è®¿é—®è¯·é€šè¿‡ç½‘é¡µè®¾ç½®ç®¡ç†å‘˜è´¦æˆ·å’Œå¯†ç 
      {% endif %}

      ðŸ“‚ æ•°æ®å­˜å‚¨ï¼š
      - é…ç½®ç›®å½•: {{ dify_compose_path }}
      - æ•°æ®å·ç›®å½•: {{ dify_compose_path }}/volumes

      ðŸ› ï¸  ç®¡ç†å‘½ä»¤ï¼š
      - æŸ¥çœ‹æ—¥å¿—: docker compose -f {{ dify_compose_path }}/docker-compose.yaml logs
      - é‡å¯æœåŠ¡: docker compose -f {{ dify_compose_path }}/docker-compose.yaml restart
      - åœæ­¢æœåŠ¡: docker compose -f {{ dify_compose_path }}/docker-compose.yaml down

      ðŸ’¡ æç¤ºï¼š
      - é…ç½®æ–‡ä»¶ä½äºŽ: {{ dify_compose_path }}/.env
      - ä¿®æ”¹é…ç½®åŽéœ€è¦é‡å¯: docker compose -f {{ dify_compose_path }}/docker-compose.yaml up -d

- name: åœæ­¢æŒ‡å®šæœåŠ¡ï¼ˆç»´æŠ¤æ¨¡å¼ï¼‰
  community.docker.docker_compose_v2:
    project_src: "{{ dify_compose_path }}"
    project_name: "{{ dify_project_name }}"
    services: "{{ dify_compose_stopped_services }}"
    state: stopped
  when: dify_compose_stopped_services | length > 0

# å¯é€‰ï¼šè®¾ç½®å®šæ—¶å¤‡ä»½
- name: è®¾ç½®æ•°æ®åº“å¤‡ä»½å®šæ—¶ä»»åŠ¡
  ansible.builtin.cron:
    name: "Dify æ•°æ®åº“å¤‡ä»½"
    minute: "0"
    hour: "2"
    job: |
      cd {{ dify_compose_path }} &&
      docker compose exec -T db pg_dump -U postgres dify |
      gzip > {{ dify_base_path }}/backup/dify_backup_$(date +\%Y\%m\%d_\%H\%M\%S).sql.gz &&
      find {{ dify_base_path }}/backup -name "dify_backup_*.sql.gz" -mtime +{{ dify_backup_retention_days }} -delete
    state: "{{ 'present' if dify_backup_enabled else 'absent' }}"
  when: dify_backup_enabled is defined

- name: åˆ›å»ºå¤‡ä»½ç›®å½•
  ansible.builtin.file:
    path: "{{ dify_base_path }}/backup"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: dify_backup_enabled